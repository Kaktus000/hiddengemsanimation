<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Animation Bot Exporter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --border: #334155;
            --accent: #3b82f6;
            --text: #f8fafc;
            --text-muted: #94a3b8;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container { max-width: 800px; width: 100%; }
        header { text-align: center; margin-bottom: 40px; }
        h1 { color: var(--accent); margin-bottom: 8px; font-size: 2.5rem; }
        
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 24px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        label { display: block; font-size: 0.875rem; color: var(--text-muted); margin-bottom: 8px; }
        
        input[type="number"] {
            width: 100%;
            background: #0f172a;
            border: 1px solid var(--border);
            color: white;
            padding: 10px;
            border-radius: 8px;
            box-sizing: border-box;
        }

        /* Drag & Drop Area */
        #dropZone {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        #dropZone.dragover {
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.1);
        }

        /* Progress Bar */
        .progress-container { margin-top: 20px; display: none; }
        .progress-bar-bg { background: #0f172a; height: 8px; border-radius: 4px; overflow: hidden; }
        #progressBar { background: var(--accent); height: 100%; width: 0%; transition: width 0.1s; }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 1rem;
            transition: transform 0.1s, background 0.2s;
        }

        .btn-primary { background: var(--accent); color: white; }
        .btn-disabled { background: #334155; color: #64748b; cursor: not-allowed; }
        .btn:active:not(.btn-disabled) { transform: scale(0.98); }

        canvas { background: black; display: block; max-width: 100%; height: auto; image-rendering: pixelated; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Animation Bot</h1>
            <p style="color: var(--text-muted)">Drag & Drop Video Encoder</p>
        </header>

        <div class="card">
            <div class="grid">
                <div>
                    <label>Breite (X)</label>
                    <input type="number" id="width" value="29">
                </div>
                <div>
                    <label>Höhe (Y)</label>
                    <input type="number" id="height" value="19">
                </div>
            </div>
        </div>

        <div class="card">
            <div id="dropZone">
                <i data-lucide="upload-cloud" size="48"></i>
                <p>Zieh dein Video (.mp4) oder animation.json hierher</p>
                <span style="font-size: 0.8rem; color: var(--text-muted)">oder klicken zum Auswählen</span>
                <input type="file" id="fileInput" class="hidden" accept="video/*,.json">
            </div>

            <div id="progressContainer" class="progress-container">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span id="statusText">Bereit...</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="progress-bar-bg">
                    <div id="progressBar"></div>
                </div>
            </div>
        </div>

        <div class="card">
            <div id="previewArea" class="hidden">
                <p style="color: #4ade80; margin-bottom: 12px;">✓ Datei bereit zum Export</p>
                <canvas id="previewCanvas" style="margin: 0 auto 20px auto;"></canvas>
            </div>
            
            <button id="downloadBtn" class="btn btn-disabled" disabled>
                <i data-lucide="download"></i>
                ZIP BUNDLE HERUNTERLADEN
            </button>
        </div>
    </div>

    <video id="processVideo" class="hidden"></video>

    <script>
        // Initialisiere Icons
        lucide.createIcons();

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const downloadBtn = document.getElementById('downloadBtn');
        const progressBar = document.getElementById('progressBar');
        const progressPercent = document.getElementById('progressPercent');
        const progressContainer = document.getElementById('progressContainer');
        const statusText = document.getElementById('statusText');
        const previewArea = document.getElementById('previewArea');
        const previewCanvas = document.getElementById('previewCanvas');
        const ctx = previewCanvas.getContext('2d');

        let generatedJson = null;

        // --- Drag & Drop Handler ---
        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) handleFile(e.target.files[0]);
        });

        function handleFile(file) {
            if (file.name.endsWith('.json')) {
                handleJson(file);
            } else if (file.type.startsWith('video/')) {
                handleVideo(file);
            } else {
                alert("Bitte nur Videos oder .json Dateien hochladen.");
            }
        }

        // --- JSON Logic ---
        function handleJson(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    generatedJson = data;
                    renderPreviewFrame(data);
                    enableDownload();
                } catch (err) { alert("Fehler in JSON-Struktur"); }
            };
            reader.readAsText(file);
        }

        // --- Video Logic (The Encoder) ---
        async function handleVideo(file) {
            const width = parseInt(document.getElementById('width').value);
            const height = parseInt(document.getElementById('height').value);
            const video = document.getElementById('processVideo');
            
            progressContainer.style.display = 'block';
            statusText.innerText = "Lade Video...";
            
            const url = URL.createObjectURL(file);
            video.src = url;

            video.onloadedmetadata = async () => {
                const fps = 10; 
                const totalFrames = Math.floor(video.duration * fps);
                const frames = {};
                previewCanvas.width = width;
                previewCanvas.height = height;

                for (let i = 0; i < totalFrames; i++) {
                    video.currentTime = i / fps;
                    await new Promise(r => video.onseeked = r);

                    ctx.drawImage(video, 0, 0, width, height);
                    const imgData = ctx.getImageData(0, 0, width, height).data;
                    
                    const frameData = {};
                    for (let y = 0; y < height; y++) {
                        const row = [];
                        for (let x = 0; x < width; x++) {
                            const idx = (y * width + x) * 4;
                            const r = imgData[idx].toString(16).padStart(2, '0');
                            const g = imgData[idx+1].toString(16).padStart(2, '0');
                            const b = imgData[idx+2].toString(16).padStart(2, '0');
                            row.push(`#${r}${g}${b}`);
                        }
                        frameData[`row${y + 1}`] = row;
                    }
                    frames[`frame${i + 1}`] = frameData;

                    const pct = Math.round((i / totalFrames) * 100);
                    progressBar.style.width = `${pct}%`;
                    progressPercent.innerText = `${pct}%`;
                    statusText.innerText = `Frame ${i} von ${totalFrames} extrahiert...`;
                }

                generatedJson = {
                    meta: { x_size: width, y_size: height, frame_count: totalFrames },
                    frames: frames
                };
                
                statusText.innerText = "Fertig!";
                enableDownload();
                URL.revokeObjectURL(url);
            };
        }

        function enableDownload() {
            previewArea.classList.remove('hidden');
            downloadBtn.disabled = false;
            downloadBtn.classList.remove('btn-disabled');
            downloadBtn.classList.add('btn-primary');
        }

        function renderPreviewFrame(data) {
            previewCanvas.width = data.meta.x_size;
            previewCanvas.height = data.meta.y_size;
            const frame = data.frames.frame1;
            for(let y=0; y<data.meta.y_size; y++) {
                frame[`row${y+1}`].forEach((c, x) => {
                    ctx.fillStyle = c;
                    ctx.fillRect(x, y, 1, 1);
                });
            }
        }

        // --- ZIP Export ---
        downloadBtn.addEventListener('click', async () => {
            if (!generatedJson) return;
            const zip = new JSZip();
            zip.file("animation.json", JSON.stringify(generatedJson, null, 4));

            const files = ['bot.py', 'bot.yaml', 'start.bat', 'start.sh'];
            statusText.innerText = "Sammle Dateien...";

            for (const f of files) {
                try {
                    const res = await fetch(f);
                    if (res.ok) zip.file(f, await res.blob());
                } catch (e) { console.error("Datei fehlte im Repo:", f); }
            }

            const content = await zip.generateAsync({type:"blob"});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(content);
            a.download = "bot_bundle.zip";
            a.click();
            statusText.innerText = "Download gestartet!";
        });
    </script>
</body>
</html>
