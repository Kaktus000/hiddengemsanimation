<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Hidden Gems Video Player (Python PIL Core)</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
    
    <style>
        :root { --bg: #0d1117; --card: #161b22; --border: #30363d; --accent: #238636; --text: #c9d1d9; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; display: flex; justify-content: center; padding: 20px; }
        .container { max-width: 600px; width: 100%; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        #dropZone { border: 2px dashed var(--border); padding: 40px; text-align: center; cursor: pointer; border-radius: 12px; }
        #dropZone.loading { cursor: wait; opacity: 0.5; }
        .btn { width: 100%; padding: 15px; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn:disabled { background: #21262d; color: #8b949e; cursor: not-allowed; }
        input { width: 50px; background: #0d1117; border: 1px solid var(--border); color: white; padding: 5px; }
        .log { font-size: 0.8rem; color: #8b949e; margin-top: 10px; font-family: monospace; }
        #preview { image-rendering: pixelated; width: 100%; max-width: 400px; display: block; margin: 10px auto; border: 1px solid var(--border); }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2>Hidden Gems Video Player</h2>
        <p style="font-size: 0.8rem;">Diese Version führt <b>Original Pillow (Python)</b> via WebAssembly aus.</p>
        <div id="status">Lade Python Kern (PIL)...</div>
    </div>

    <div class="card">
        X: <input type="number" id="width" value="49"> 
        Y: <input type="number" id="height" value="29">
        Frames: <input type="number" id="maxFrames" value="0"> (0=alle)
    </div>

    <div class="card" id="dropZone">
        <div id="dropText">Warte auf Python...</div>
        <input type="file" id="fileInput" hidden accept="video/*">
    </div>

    <div class="card">
        <div id="progressText">Bereit.</div>
        <canvas id="preview"></canvas>
        <button id="dlBtn" class="btn" disabled>BOT-BUNDLE ZIP DOWNLOAD</button>
        <div class="log" id="logger"></div>
    </div>
</div>

<video id="vCore" hidden muted playsinline></video>

<script>
    const $ = id => document.getElementById(id);
    let pyodide;
    let finalJson = null;

    // --- 1. PYTHON UMGEBUNG INITIALISIEREN ---
    async function initPython() {
        try {
            pyodide = await loadPyodide();
            await pyodide.loadPackage("micropip");
            const micropip = pyodide.pyimport("micropip");
            await micropip.install("Pillow");
            
            $('status').innerText = "✅ PIL (Pillow) ist bereit!";
            $('dropText').innerText = "Video hierher ziehen oder klicken";
            $('dropZone').classList.remove('loading');
        } catch (e) {
            $('status').innerText = "❌ Fehler beim Laden von Python.";
            console.error(e);
        }
    }
    initPython();

    $('dropZone').onclick = () => { if(pyodide) $('fileInput').click(); };
    $('fileInput').onchange = e => handle(e.target.files[0]);

    async function handle(file) {
        const v = $('vCore');
        v.src = URL.createObjectURL(file);
        await new Promise(r => v.onloadedmetadata = r);

        const w = parseInt($('width').value);
        const h = parseInt($('height').value);
        const limit = parseInt($('maxFrames').value) || 9999;
        const fps = 10;
        const total = Math.min(Math.floor(v.duration * fps), limit);
        
        const cap = document.createElement('canvas');
        cap.width = v.videoWidth; cap.height = v.videoHeight;
        const ctx = cap.getContext('2d', {willReadFrequently: true});
        const frames = {};

        for(let i=0; i<total; i++) {
            v.currentTime = i / fps;
            await new Promise(r => v.onseeked = r);
            
            // Frame-Capture Sicherheit
            ctx.drawImage(v, 0, 0);
            const imageData = ctx.getImageData(0, 0, cap.width, cap.height);
            
            // --- 2. ÜBERGABE AN ECHTES PILLOW ---
            // Wir schicken die Rohdaten an Python
            pyodide.globals.set("raw_data", imageData.data);
            pyodide.globals.set("src_w", cap.width);
            pyodide.globals.set("src_h", cap.height);
            pyodide.globals.set("target_w", w);
            pyodide.globals.set("target_h", h);

            const pythonCode = `
from PIL import Image
import numpy as np

# Image aus JS-Bytes erstellen
img = Image.frombytes("RGBA", (src_w, src_h), raw_data.to_py())

# 1:1 DEIN LOGIK-KERN
img = img.resize((target_w, target_h), Image.NEAREST)

# Hex-Daten extrahieren
res = {}
for y in range(target_h):
    row = []
    for x in range(target_w):
        r, g, b, a = img.getpixel((x, y))
        if a == 0:
            row.append("#000000")
        else:
            row.append(f"#{r:02x}{g:02x}{b:02x}")
    res[f"row{y+1}"] = row

# Zurück an JS
res
`;
            const frameResult = await pyodide.runPythonAsync(pythonCode);
            frames[`frame${i+1}`] = frameResult.toJs();

            // Preview Update
            if (i % 5 === 0) {
                $('progressText').innerText = `Verarbeite Frame ${i+1}/${total} mit PIL...`;
                drawPreview(frames[`frame${i+1}`], w, h);
            }
        }

        finalJson = { meta: { x_size: w, y_size: h, frame_count: total }, frames };
        $('progressText').innerText = "✅ Fertig! PIL hat alle Frames verarbeitet.";
        $('dlBtn').disabled = false;
    }

    function drawPreview(frame, w, h) {
        const pC = $('preview'); pC.width = w; pC.height = h;
        const pX = pC.getContext('2d');
        for(let y=0; y<h; y++) {
            const row = frame[`row${y+1}`];
            for(let x=0; x<w; x++) {
                pX.fillStyle = row[x];
                pX.fillRect(x, y, 1, 1);
            }
        }
    }

    $('dlBtn').onclick = async () => {
        const zip = new JSZip();
        zip.file("animation.json", JSON.stringify(finalJson, null, 4));
        const assets = ['bot.py', 'bot.yaml', 'start.bat', 'start.sh'];
        for(const a of assets) {
            try {
                const res = await fetch(a);
                if(res.ok) zip.file(a, await res.arrayBuffer());
            } catch(e) {}
        }
        const blob = await zip.generateAsync({type:"blob"});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = "bot_bundle.zip";
        link.click();
    };
</script>
</body>
</html>
